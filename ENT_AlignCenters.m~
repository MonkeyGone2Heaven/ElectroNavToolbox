
%========================== ENT_AlignCenters.m ============================ 
% This subfunction is used to align the origins of two volumes that are
% already coregistered but have different resolutions, and/or bounding box 
% sizes. For example, if a T1-weighted (MDEFT) and T2-weighted (FLASH) 
% structural volumes were acquired in the same session at different resolutions
% then they should already be spatially registered.
%
% ELECTRONAV TOOLBOX
% Developed by Aidan Murphy, © Copyleft 2015, GNU General Public License
%==========================================================================

function ENT_AlignCenters(NiiFile1, NiiFile2)

if nargin<2
    [File1, Path] = uigetfile({'*.nii;*.img'},'Select first MR volume');
    NiiFile1 = fullfile(Path, File1);
    [File2, Path] = uigetfile({'*.nii;*.img'},'Select second MR volume', Path);
    NiiFile2 = fullfile(Path, File2);
end

%===== Load volumes
Nii1 = load_nii(NiiFile1);
Nii2 = load_nii(NiiFile2);

%===== Check volumes have same resolution
if Nii1.hdr.dime.pixdim(2:4)~= Nii2.hdr.dime.pixdim(2:4)
    NewRes = min([Nii1.hdr.dime.pixdim(2:4), Nii2.hdr.dime.pixdim(2:4)]);
    
    reslice_nii();
end

%===== 
FH = figure;
ax(1) = subplot(1,3,1);
imagesc(Nii1.img(:,:,Nii1.hdr.hist.originator(3)));
axis tight 


%===== Calculate volume dimensions
SizeDiff = Nii1.hdr.dime.dim(2:4)-Nii2.hdr.dime.dim(2:4);
Offset = Nii1.hdr.hist.originator(1:3)-Nii2.hdr.hist.originator(1:3);

if all(SizeDiff>0)                                      % If volume 1 is larger than volume 2 in all dimensions...
    NewVol = zeros(size(Nii1.hdr.dime.dim(2:4)));       % Create new empty volume
    Xrange = Offset(1)+(1:Nii2.hdr.dime.dim(2));   
    Yrange = Offset(2)+(1:Nii2.hdr.dime.dim(3));
    Zrange = Offset(3)+(1:Nii2.hdr.dime.dim(4));
    NewVol(Xrange, Yrange, Zrange) = Nii2.img;          % Insert original volume
    
    Nii1.img =  NewVol;
    Filename = sprintf('%s_Aligned.nii', NiiFile2(1:strfind(NiiFile2,'.nii')-1));
end
save_nii(Nii1, Filename);                               % Save new volume